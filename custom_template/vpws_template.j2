tenants:
{%  for tenant in tenants  %}
  {{ tenant.name }}:
    mac_vrf_rt_base: {{ tenant.mac_vrf_rt_base }}
    pseudowire_rt_base: {{ tenant.pseudowire_rt_base }}
    mac_vrf_vni_base: {{ tenant.mac_vrf_vni_base }}
    vlan_aware_bundle_number_base: {{ tenant.vlan_aware_bundle_number_base }}
    point_to_point_services:
{%      for service in tenant.services  %}
{%        set id1_count = namespace(value=0) %}
{%        set id2_count = namespace(value=0) %}
{%        set total_count = namespace(value=0) %}
{%        set parentif_id = namespace(value=1) %}
{%        set parentif_id_offset = namespace(value=0) %}
{%        for service_id in tenant.service_count  %}
      - name: {{ service.name }}_{{ service_id }}
        type: vpws-pseudowire
        subinterfaces:
{%          for id in service.ids  %}
          - number: {{ id}}
{%          endfor %}
        endpoints:
          - id: {{ service.start_id1 + id1_count.value }}
            nodes: {{ service.node_set1 }}
{%          set subif_id = namespace(value=1) %}
{%          if total_count.value%4 > 0 %}
{%            set subif_id.value = total_count.value%4 + 1  %}
{%          endif %}
{%          if ((total_count.value / 4) | round(0, 'floor') | int ) > parentif_id_offset.value %}
{%            set parentif_id.value = parentif_id.value + 2 %}
{%            set parentif_id_offset.value = parentif_id_offset.value  + 1 %}
{%          endif %}
            interfaces: [ "{{ "Ethernet" ~ parentif_id.value ~ "/" ~ subif_id.value }}" , "{{ "Ethernet" ~ parentif_id.value ~ "/" ~ subif_id.value }}"]
            port_channel:
              mode: active
              short_esi: {{ service.short_esi1 ~ ":" ~ '%04x' % total_count.value }}
          - id: {{ service.start_id2 + id2_count.value }}
            nodes: {{ service.node_set2 }}
            interfaces: [ "{{ "Ethernet" ~ parentif_id.value ~ "/" ~ subif_id.value }}" , "{{ "Ethernet" ~ parentif_id.value ~ "/" ~ subif_id.value }}"]
            port_channel:
              mode: active
              short_esi: {{ service.short_esi2 ~ ":" ~ '%04x' % total_count.value }}
{%        set id1_count.value = id1_count.value  + service.ids|length %}
{%        set id2_count.value = id2_count.value  + service.ids|length %}
{%        set total_count.value = total_count.value  + 1 %}
{%        endfor %}
    vrfs:
{%        set total_count = namespace(value=0) %}
{%        for p2mp_id in tenant.p2mp_service_count  %}
      P2MP_{{tenant.name}}_{{ p2mp_id }}:
        vrf_id: {{tenant.p2mp_service_rt_id_base + loop.index }}
        svis:
{%          for vlan_id in tenant.p2mp_vlan_per_vrf_count %}
          {{ tenant.p2mp_service_vlan_base + total_count.value  }}:
            name: v{{ tenant.p2mp_service_vlan_base + total_count.value  }}
            enabled: true
            ip_address_virtual: {{ tenant.p2mp_ip_prefix }}.{{ total_count.value }}.1/24
            tags: {{ tenant.p2mp_tag_set }}
{%            set total_count.value = total_count.value  + 1 %}
{%          endfor %}
{%        endfor %}
{%      endfor %}
    l2vlans:
      10:
        name: TENANT_A_L2_SERVICE
        tags:
          - frankfurt
          - berlin
  TENANT_B:
    pseudowire_rt_base: 2000
    mac_vrf_rt_base: 20000
    mac_vrf_vni_base: 5000
    vlan_aware_bundle_number_base: 5000
    vrfs:
      INTERNET:
        vrf_id: 20000
        vtep_diagnostic:
          loopback: 2000
          loopback_ip_range: 10.0.0.0/24
        additional_route_targets:
          - type: export
            address_family: evpn
            route_target: "65000:20001"
          - type: export
            address_family: evpn
            route_target: "65000:20002"
        address_families:
          - evpn
        l3_interfaces:
          - description: TENANT_B_SITE_3_INTRA_L3VPN
            enabled: true
            interfaces:
            - Ethernet21/1
            - Ethernet21/1
            - Ethernet21/1
            - Ethernet2/1
            - Ethernet11/4.3000
            - Ethernet11/4.3001
            ip_addresses:
            - 172.16.3.0/31
            - 172.16.3.2/31
            - 172.16.3.4/31
            - 172.16.3.6/31
            - 172.16.3.8/31
            - 172.16.3.10/31
            nodes:
            - smm153
            - smm154
            - smm313
            - smm313
            - smm153
            - smm154
        bgp_peers:
          172.16.3.1:
            maximum_routes: 0
            description: TENANT_B_CPE_SITE3
            # ebgp_multihop: 1
            nodes:
            - smm153
            remote_as: "65501"
          172.16.3.3:
            maximum_routes: 0
            description: TENANT_B_CPE_SITE3
            # ebgp_multihop: 1
            nodes:
            - smm154
            remote_as: "65501"
          172.16.3.5:
            maximum_routes: 0
            description: TENANT_B_CPE_SITE3
            # ebgp_multihop: 1
            nodes:
            - smm313
            remote_as: "65501"
          172.16.3.7:
            maximum_routes: 0
            description: TENANT_B_CPE_SITE3
            # ebgp_multihop: 1
            nodes:
            - smm313
            remote_as: "65501"
          172.16.3.9:
            maximum_routes: 0
            description: TENANT_B_CPE_SITE3
            # ebgp_multihop: 1
            nodes:
            - smm153
            remote_as: "65502"
          172.16.3.11:
            maximum_routes: 0
            description: TENANT_B_CPE_SITE3
            # ebgp_multihop: 1
            nodes:
            - smm154
            remote_as: "65502"
      PREMIUM1:
        vrf_id: 20001
        vtep_diagnostic:
          loopback: 2001
          loopback_ip_range: 10.0.0.0/24
        address_families:
          - evpn
        l3_interfaces:
          - description: PREMIUM1
            enabled: true
            interfaces:
            - Ethernet22/1
            - Ethernet22/1
            ip_addresses:
            - 172.16.3.0/31
            - 172.16.4.0/31
            nodes:
            - smm153
            - smm313
    l2vlans:
      20:
        name: TENANT_B_L2_SERVICE
        tags:
          - frankfurt
          - berlin
{%  endfor %}