---
- name: Build Switch configuration
  hosts: MPLS_FABRIC
  connection: local
  gather_facts: false
  collections:
    - arista.avd
    - arista.cvp

  tasks:
    - name: Generate POC Tenants
      # tags: [poc, never]
      template:
        src: custom_template/vpws_template.j2
        dest: group_vars/MPLS_TENANTS_TEST.yml
      vars:
        tenants:
          - name: TENANT_TEST
            mac_vrf_rt_base: 10000
            pseudowire_rt_base: 1000
            service_count: "{{ range(1, 10) }}"
            services:
              - name: TEN_A_FRA_BER_eline_vlan_based
                ids: "{{ range(1000, 1010) }}"
                start_id1: 20000
                node_set1: ["smm153", "smm154"]
                interface_set1: ["Ethernet1/1", "Ethernet1/1"]
                short_esi1: 0101:0202:0101
                start_id2: 30000
                node_set2: ["smm311", "smm312"]
                interface_set2: ["Ethernet1/1", "Ethernet1/1"]
                short_esi2: 0101:0202:0101
      delegate_to: localhost
    - name: 'build local folders for output'
      tags: [build, generate]
      import_role:
        name: arista.avd.build_output_folders

    - name: generate intended variables
      tags: [build, generate]
      import_role:
        name: arista.avd.eos_designs
      vars:
        design:
          type: "mpls-vpn"

    - name: generate device intended config and documentation
      tags: [build, generate]
      import_role:
        name: arista.avd.eos_cli_config_gen

# - name: Configuration deployment with CVP
#   hosts: cv_server
#   connection: local
#   gather_facts: false
#   tasks:
#     - name: run CVP provisioning
#       import_role:
#         name: arista.avd.eos_config_deploy_cvp
#       vars:
#         container_root: 'MPLS_FABRIC'
#         configlets_prefix: 'MPLS-AVD'
#         # execute_tasks: true
#         device_filter:
#           - "p"
#           - "pe"
#           - "rr"
#         search_key: hostname
#         state: present
#         cv_collection: v3
#         apply_mode: strict
